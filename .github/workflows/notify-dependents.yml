name: Notify Dependent Repositories

on:
  release:
    types: [published]

jobs:
  notify-dependents:
    name: Trigger updates in dependent repos
    runs-on: ubuntu-latest
    steps:
      - name: Get release version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Trigger omniedge-docker
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_DISPATCH_TOKEN }}
          repository: omniedgeio/omniedge-docker
          event-type: cli-release
          client-payload: '{"version": "${{ steps.version.outputs.version }}", "tag": "${{ steps.version.outputs.tag }}"}'

      - name: Trigger omniedge-openwrt
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_DISPATCH_TOKEN }}
          repository: omniedgeio/omniedge-openwrt
          event-type: cli-release
          client-payload: '{"version": "${{ steps.version.outputs.version }}", "tag": "${{ steps.version.outputs.tag }}"}'

      - name: Trigger omniedge-synology
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_DISPATCH_TOKEN }}
          repository: omniedgeio/omniedge-synology
          event-type: cli-release
          client-payload: '{"version": "${{ steps.version.outputs.version }}", "tag": "${{ steps.version.outputs.tag }}"}'

      - name: Trigger github-action
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_DISPATCH_TOKEN }}
          repository: omniedgeio/github-action
          event-type: cli-release
          client-payload: '{"version": "${{ steps.version.outputs.version }}", "tag": "${{ steps.version.outputs.tag }}"}'

      - name: Trigger omniedge-web-frontend
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_DISPATCH_TOKEN }}
          repository: omniedgeio/omniedge-web-frontend
          event-type: cli-release
          client-payload: '{"version": "${{ steps.version.outputs.version }}", "tag": "${{ steps.version.outputs.tag }}"}'

      - name: Summary
        run: |
          echo "## ðŸš€ Triggered Dependency Updates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "CLI Version: **${{ steps.version.outputs.tag }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Notified repositories:" >> $GITHUB_STEP_SUMMARY
          echo "- omniedge-docker" >> $GITHUB_STEP_SUMMARY
          echo "- omniedge-openwrt" >> $GITHUB_STEP_SUMMARY
          echo "- omniedge-synology" >> $GITHUB_STEP_SUMMARY
          echo "- github-action" >> $GITHUB_STEP_SUMMARY
          echo "- omniedge-web-frontend" >> $GITHUB_STEP_SUMMARY
