name: OmniEdge Desktop Build

on:
  push:
    tags:
      - 'desktop-v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.1)'
        required: true
        default: '1.0.1'

env:
  GO_VERSION: '1.21'
  NODE_VERSION: '20'

jobs:
  # Build Windows installer with TAP driver
  build-windows:
    name: Build Windows (amd64)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

      - name: Install NSIS
        run: choco install nsis -y

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION="${GITHUB_REF#refs/tags/desktop-v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Build Desktop App
        working-directory: shell/desktop
        run: |
          wails3 task windows:build

      - name: Build Helper
        run: |
          go build -o shell/desktop/bin/omniedge-helper.exe ./cmd/omniedge-helper

      - name: Create NSIS Installer
        working-directory: shell/desktop
        run: |
          wails3 task windows:package

      - name: Rename installer
        working-directory: shell/desktop
        run: |
          mv bin/OmniEdge-amd64-installer.exe bin/omniedge-desktop-${{ steps.version.outputs.version }}-windows-amd64.exe

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: omniedge-desktop-${{ steps.version.outputs.version }}-windows-amd64
          path: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-windows-amd64.exe

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-windows-amd64.exe
          tag: ${{ github.ref }}
          overwrite: true

  # Build Linux packages (deb and rpm)
  build-linux:
    name: Build Linux (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev build-essential pkg-config

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

      - name: Install nfpm
        run: |
          go install github.com/goreleaser/nfpm/v2/cmd/nfpm@latest

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION="${GITHUB_REF#refs/tags/desktop-v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Build Desktop App
        working-directory: shell/desktop
        run: |
          wails3 task linux:build

      - name: Build Helper
        run: |
          CGO_ENABLED=1 go build -o shell/desktop/bin/omniedge-helper ./cmd/omniedge-helper

      - name: Build DEB package
        working-directory: shell/desktop
        env:
          GOARCH: ${{ matrix.arch }}
          GIT_COMMITTER_NAME: "OmniEdge"
          GIT_COMMITTER_EMAIL: "support@omniedge.io"
        run: |
          nfpm package -p deb -f build/linux/nfpm/nfpm.yaml -t bin/

      - name: Build RPM package
        working-directory: shell/desktop
        env:
          GOARCH: ${{ matrix.arch }}
          GIT_COMMITTER_NAME: "OmniEdge"
          GIT_COMMITTER_EMAIL: "support@omniedge.io"
        run: |
          nfpm package -p rpm -f build/linux/nfpm/nfpm.yaml -t bin/

      - name: Rename packages
        working-directory: shell/desktop/bin
        run: |
          mv omniedge_*.deb omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.deb
          mv omniedge-*.rpm omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.rpm

      - name: Upload DEB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}-deb
          path: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.deb

      - name: Upload RPM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}-rpm
          path: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.rpm

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file_glob: true
          file: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.*
          tag: ${{ github.ref }}
          overwrite: true

  # Build macOS (arm64 only)
  build-macos:
    name: Build macOS (arm64)
    runs-on: macos-14  # M1/M2 runner for arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          brew install autoconf automake libtool

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION="${GITHUB_REF#refs/tags/desktop-v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Generate n2n library
        working-directory: internal
        run: |
          go generate ./...

      - name: Build Desktop App
        working-directory: shell/desktop
        run: |
          wails3 task darwin:build

      - name: Build Helper
        run: |
          CGO_ENABLED=1 go build -o shell/desktop/bin/omniedge-helper ./cmd/omniedge-helper

      - name: Create DMG
        working-directory: shell/desktop
        run: |
          # Create app bundle directory structure
          mkdir -p bin/OmniEdge.app/Contents/MacOS
          mkdir -p bin/OmniEdge.app/Contents/Resources
          cp bin/OmniEdge bin/OmniEdge.app/Contents/MacOS/
          cp build/darwin/Info.plist bin/OmniEdge.app/Contents/
          cp build/darwin/icons.icns bin/OmniEdge.app/Contents/Resources/
          
          # Copy helper
          cp bin/omniedge-helper bin/OmniEdge.app/Contents/MacOS/
          
          # Sign the app
          codesign --force --deep --sign - bin/OmniEdge.app
          
          # Create DMG
          hdiutil create -volname "OmniEdge" -srcfolder bin/OmniEdge.app -ov -format UDZO bin/omniedge-desktop-${{ steps.version.outputs.version }}-macos-arm64.dmg

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: omniedge-desktop-${{ steps.version.outputs.version }}-macos-arm64
          path: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-macos-arm64.dmg

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-macos-arm64.dmg
          tag: ${{ github.ref }}
          overwrite: true

  # Summary job
  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, build-macos]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Get version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/desktop-v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## ðŸš€ OmniEdge Desktop ${{ steps.version.outputs.version }} Released" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages Built:" >> $GITHUB_STEP_SUMMARY
          echo "- **Windows**: omniedge-desktop-${{ steps.version.outputs.version }}-windows-amd64.exe (NSIS installer with TAP driver)" >> $GITHUB_STEP_SUMMARY
          echo "- **Linux DEB**: omniedge-desktop-${{ steps.version.outputs.version }}-linux-amd64.deb (Ubuntu/Debian)" >> $GITHUB_STEP_SUMMARY
          echo "- **Linux RPM**: omniedge-desktop-${{ steps.version.outputs.version }}-linux-amd64.rpm (RHEL/CentOS/Fedora)" >> $GITHUB_STEP_SUMMARY
          echo "- **macOS**: omniedge-desktop-${{ steps.version.outputs.version }}-macos-arm64.dmg (Apple Silicon)" >> $GITHUB_STEP_SUMMARY
