name: OmniEdge Desktop Build

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.1)'
        required: true
        default: '1.0.1'

env:
  GO_VERSION: '1.25'
  NODE_VERSION: '20'

jobs:
  # Build Windows installer with TAP driver
  build-windows:
    name: Build Windows (amd64)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

      - name: Install NSIS
        run: |
          choco install nsis -y
          echo "C:\Program Files (x86)\NSIS" >> $env:GITHUB_PATH

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Generate n2n library
        working-directory: internal
        run: |
          go generate ./...

      - name: Build Desktop App
        working-directory: shell/desktop
        run: |
          wails3 task windows:build

      - name: Build Helper
        run: |
          go build -o shell/desktop/bin/omniedge-helper.exe ./cmd/omniedge-helper

      - name: Create NSIS Installer
        working-directory: shell/desktop
        run: |
          wails3 task windows:package

      - name: Rename installer
        working-directory: shell/desktop
        run: |
          mv bin/OmniEdge-amd64-installer.exe bin/omniedge-desktop-${{ steps.version.outputs.version }}-windows-amd64.exe

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: omniedge-desktop-${{ steps.version.outputs.version }}-windows-amd64
          path: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-windows-amd64.exe

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-windows-amd64.exe
          tag: ${{ github.ref }}
          overwrite: true

  # Build Linux packages (deb, rpm, AppImage, Flatpak, Arch)
  build-linux:
    name: Build Linux (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev build-essential pkg-config
          sudo apt-get install -y autoconf automake libtool  # For n2n build
          sudo apt-get install -y libfuse2 fuse  # For AppImage
          sudo apt-get install -y flatpak flatpak-builder  # For Flatpak

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

      - name: Install nfpm
        run: |
          go install github.com/goreleaser/nfpm/v2/cmd/nfpm@latest

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Generate n2n library
        working-directory: internal
        run: |
          go generate ./...

      - name: Build Desktop App
        working-directory: shell/desktop
        run: |
          wails3 task linux:build

      - name: Build Helper
        run: |
          CGO_ENABLED=1 go build -o shell/desktop/bin/omniedge-helper ./cmd/omniedge-helper

      # --- DEB Package ---
      - name: Build DEB package
        working-directory: shell/desktop
        env:
          GOARCH: ${{ matrix.arch }}
          GIT_COMMITTER_NAME: "OmniEdge"
          GIT_COMMITTER_EMAIL: "support@omniedge.io"
        run: |
          nfpm package -p deb -f build/linux/nfpm/nfpm.yaml -t bin/
          mv bin/omniedge_*.deb bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.deb

      # --- RPM Package ---
      - name: Build RPM package
        working-directory: shell/desktop
        env:
          GOARCH: ${{ matrix.arch }}
          GIT_COMMITTER_NAME: "OmniEdge"
          GIT_COMMITTER_EMAIL: "support@omniedge.io"
        run: |
          nfpm package -p rpm -f build/linux/nfpm/nfpm.yaml -t bin/
          mv bin/omniedge-*.rpm bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.rpm

      # --- AppImage ---
      - name: Build AppImage
        working-directory: shell/desktop
        run: |
          export APP_NAME="OmniEdge"
          export APP_BINARY="bin/OmniEdge"
          export ICON_PATH="build/appicon.png"
          export DESKTOP_FILE="build/linux/desktop"
          
          # Download linuxdeploy
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          
          # Create AppDir
          mkdir -p OmniEdge.AppDir/usr/bin
          cp bin/OmniEdge OmniEdge.AppDir/usr/bin/omniedge
          cp bin/omniedge-helper OmniEdge.AppDir/usr/bin/
          cp build/appicon.png OmniEdge.AppDir/omniedge.png
          cp build/linux/desktop OmniEdge.AppDir/omniedge.desktop
          
          # Build AppImage
          ./linuxdeploy-x86_64.AppImage --appdir OmniEdge.AppDir --output appimage
          mv OmniEdge*.AppImage bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.AppImage

      # --- Flatpak ---
      - name: Setup Flatpak
        run: |
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub org.gnome.Platform//45 org.gnome.Sdk//45

      - name: Build Flatpak
        working-directory: shell/desktop
        run: |
          # Copy binaries to flatpak build dir
          mkdir -p build/linux/flatpak/build
          cp bin/OmniEdge build/linux/flatpak/omniedge
          cp bin/omniedge-helper build/linux/flatpak/
          cp build/appicon.png build/linux/flatpak/omniedge.png
          cp build/linux/desktop build/linux/flatpak/omniedge.desktop
          
          # Build flatpak
          flatpak-builder --user --force-clean --repo=repo build/linux/flatpak/build build/linux/flatpak/io.omniedge.desktop.yml
          flatpak build-bundle repo bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.flatpak io.omniedge.desktop

      # --- Arch Linux Package ---
      - name: Build Arch package
        working-directory: shell/desktop
        run: |
          mkdir -p bin/arch-pkg
          cp bin/OmniEdge bin/arch-pkg/omniedge
          cp bin/omniedge-helper bin/arch-pkg/
          cp build/linux/desktop bin/arch-pkg/omniedge.desktop
          cp build/appicon.png bin/arch-pkg/omniedge.png
          cp build/linux/omniedge-helper.service bin/arch-pkg/
          cp build/linux/arch/PKGBUILD bin/arch-pkg/
          
          # Update version in PKGBUILD
          sed -i "s/pkgver=.*/pkgver=${{ steps.version.outputs.version }}/" bin/arch-pkg/PKGBUILD
          
          # Create tarball for AUR
          cd bin
          tar -czvf omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}-arch.tar.gz arch-pkg/

      # --- Upload Artifacts ---
      - name: Upload DEB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}-deb
          path: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.deb

      - name: Upload RPM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}-rpm
          path: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.rpm

      - name: Upload AppImage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}-appimage
          path: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.AppImage

      - name: Upload Flatpak Artifact
        uses: actions/upload-artifact@v4
        with:
          name: omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}-flatpak
          path: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.flatpak

      - name: Upload Arch Artifact
        uses: actions/upload-artifact@v4
        with:
          name: omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}-arch
          path: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}-arch.tar.gz

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file_glob: true
          file: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.*
          tag: ${{ github.ref }}
          overwrite: true

  # Build Linux ARM64 packages (DEB, AppImage) using QEMU
  build-linux-arm64:
    name: Build Linux (arm64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-desktop-arm64-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-desktop-arm64-

      - name: Build ARM64 Desktop with Dockerfile
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/arm64
          push: false
          load: true
          file: docker/Dockerfile-desktop-arm64
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
          tags: desktop-arm64:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Extract build artifacts
        run: |
          docker run --name desktop-arm64 -d desktop-arm64:latest sleep 30
          docker cp desktop-arm64:/app/shell/desktop/bin/ ./bin-arm64/
          docker rm -f desktop-arm64
          
          # Copy artifacts to expected location
          mkdir -p shell/desktop/bin
          cp bin-arm64/OmniEdge shell/desktop/bin/
          cp bin-arm64/omniedge-helper shell/desktop/bin/
          cp bin-arm64/omniedge_*.deb shell/desktop/bin/ || true
          cp bin-arm64/*.AppImage shell/desktop/bin/ || true
          
          # List extracted artifacts
          ls -la shell/desktop/bin/

      - name: Rename packages
        working-directory: shell/desktop
        run: |
          mv bin/omniedge_*.deb bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-arm64.deb || true
          mv bin/OmniEdge*.AppImage bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-arm64.AppImage || true

      - name: Upload DEB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: omniedge-desktop-${{ steps.version.outputs.version }}-linux-arm64-deb
          path: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-arm64.deb
          if-no-files-found: warn

      - name: Upload AppImage Artifact
        uses: actions/upload-artifact@v4
        if: hashFiles('shell/desktop/bin/omniedge-desktop-*-linux-arm64.AppImage') != ''
        with:
          name: omniedge-desktop-${{ steps.version.outputs.version }}-linux-arm64-appimage
          path: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-arm64.AppImage
          if-no-files-found: warn

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file_glob: true
          file: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-linux-arm64.*
          tag: ${{ github.ref }}
          overwrite: true

  # Build macOS (arm64 only)
  build-macos:
    name: Build macOS (arm64)
    runs-on: macos-14  # M1/M2 runner for arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          brew install autoconf automake libtool

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Generate n2n library
        working-directory: internal
        run: |
          go generate ./...

      - name: Build Desktop App
        working-directory: shell/desktop
        run: |
          wails3 task darwin:build

      - name: Build Helper
        run: |
          CGO_ENABLED=1 go build -o shell/desktop/bin/omniedge-helper ./cmd/omniedge-helper

      - name: Create DMG
        working-directory: shell/desktop
        run: |
          # Create app bundle directory structure
          mkdir -p bin/OmniEdge.app/Contents/MacOS
          mkdir -p bin/OmniEdge.app/Contents/Resources
          cp bin/OmniEdge bin/OmniEdge.app/Contents/MacOS/
          cp build/darwin/Info.plist bin/OmniEdge.app/Contents/
          cp build/darwin/icons.icns bin/OmniEdge.app/Contents/Resources/
          
          # Copy helper
          cp bin/omniedge-helper bin/OmniEdge.app/Contents/MacOS/
          
          # Sign the app
          codesign --force --deep --sign - bin/OmniEdge.app
          
          # Create DMG
          hdiutil create -volname "OmniEdge" -srcfolder bin/OmniEdge.app -ov -format UDZO bin/omniedge-desktop-${{ steps.version.outputs.version }}-macos-arm64.dmg

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: omniedge-desktop-${{ steps.version.outputs.version }}-macos-arm64
          path: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-macos-arm64.dmg

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: shell/desktop/bin/omniedge-desktop-${{ steps.version.outputs.version }}-macos-arm64.dmg
          tag: ${{ github.ref }}
          overwrite: true

  # Summary job
  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, build-linux-arm64, build-macos]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Get version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## ðŸš€ OmniEdge Desktop ${{ steps.version.outputs.version }} Released" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages Built:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Windows" >> $GITHUB_STEP_SUMMARY
          echo "- **NSIS Installer**: omniedge-desktop-${{ steps.version.outputs.version }}-windows-amd64.exe (includes TAP driver)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Linux (amd64)" >> $GITHUB_STEP_SUMMARY
          echo "- **DEB**: omniedge-desktop-${{ steps.version.outputs.version }}-linux-amd64.deb (Ubuntu/Debian)" >> $GITHUB_STEP_SUMMARY
          echo "- **RPM**: omniedge-desktop-${{ steps.version.outputs.version }}-linux-amd64.rpm (RHEL/CentOS/Fedora)" >> $GITHUB_STEP_SUMMARY
          echo "- **AppImage**: omniedge-desktop-${{ steps.version.outputs.version }}-linux-amd64.AppImage (Universal)" >> $GITHUB_STEP_SUMMARY
          echo "- **Flatpak**: omniedge-desktop-${{ steps.version.outputs.version }}-linux-amd64.flatpak (GNOME/Flathub)" >> $GITHUB_STEP_SUMMARY
          echo "- **Arch**: omniedge-desktop-${{ steps.version.outputs.version }}-linux-amd64-arch.tar.gz (Arch/AUR)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Linux (arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- **DEB**: omniedge-desktop-${{ steps.version.outputs.version }}-linux-arm64.deb (Raspberry Pi/Ubuntu ARM64)" >> $GITHUB_STEP_SUMMARY
          echo "- **AppImage**: omniedge-desktop-${{ steps.version.outputs.version }}-linux-arm64.AppImage (ARM64 Universal)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### macOS" >> $GITHUB_STEP_SUMMARY
          echo "- **DMG**: omniedge-desktop-${{ steps.version.outputs.version }}-macos-arm64.dmg (Apple Silicon)" >> $GITHUB_STEP_SUMMARY

